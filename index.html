<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºèƒ½è¨ˆæ³Šä½ç³»çµ±</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { overscroll-behavior-y: contain; touch-action: pan-y; }
        .bay-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1rem; }
        .bus-card { cursor: grab; transition: all 0.2s; border-left-width: 6px; color: #000000 !important; position: relative; touch-action: none; }
        .bus-card:active { cursor: grabbing; transform: scale(1.02); }
        .status-meal { background-color: #fff7ed; border-left-color: #f97316; }
        .status-break { background-color: #faf5ff; border-left-color: #a855f7; }
        .status-normal { background-color: #ffffff; border-left-color: #64748b; }
        .editable:hover { background: rgba(0,0,0,0.1); border-radius: 4px; cursor: pointer; padding: 0 2px; }
        .etd-danger { color: #ef4444 !important; font-weight: 900; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        /* Modal Transitions */
        .modal-bg { transition: opacity 0.3s; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 font-sans h-screen flex flex-col overflow-hidden">

    <div id="terminal-modal" class="fixed inset-0 bg-slate-900/95 z-50 flex items-center justify-center backdrop-blur-sm modal-bg">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-600 max-w-md w-full text-center">
            <h1 class="text-3xl font-bold text-red-500 mb-2">æ™ºèƒ½è¨ˆæ³Šä½ç³»çµ±</h1>
            <p class="text-slate-400 mb-6">è³‡æ–™åº«ï¼šGoogle Sheet é€£ç·šä¸­</p>
            <div id="terminal-list" class="space-y-3"></div>
        </div>
    </div>

    <div id="map-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex-col items-center justify-center backdrop-blur-md" onclick="closeMap()">
        <div class="relative w-full max-w-4xl h-[80vh] flex flex-col items-center p-4">
            <div class="w-full flex justify-between items-center mb-2 text-white">
                <h2 class="text-xl font-bold">ç¸½ç«™çµæ§‹åœ–</h2>
                <button onclick="closeMap()" class="bg-slate-700 px-3 py-1 rounded hover:bg-slate-600">é—œé–‰ X</button>
            </div>
            <img id="terminal-map-img" src="" alt="Terminal Layout" class="object-contain max-w-full max-h-full rounded-lg shadow-2xl bg-white">
            <p class="text-slate-400 text-sm mt-2">é»æ“ŠèƒŒæ™¯é—œé–‰</p>
        </div>
    </div>

    <header class="bg-slate-800 border-b border-slate-700 shrink-0">
        <div class="flex justify-between items-center p-3">
            <div class="flex items-center gap-2">
                <button onclick="showTerminalModal()" class="text-sm bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded border border-slate-600 flex items-center gap-2">
                    ğŸ”„ <span id="current-terminal-name" class="font-bold text-red-400">æœªé¸æ“‡</span>
                </button>
                
                <button id="btn-show-map" onclick="showMap()" class="hidden text-sm bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded border border-blue-400 items-center gap-1 shadow">
                    ğŸ—ºï¸ çµæ§‹åœ–
                </button>

                <div id="clock" class="font-mono text-lg bg-black/30 px-3 py-1 rounded text-green-400 hidden sm:block">00:00:00</div>
            </div>
            <div id="api-status" class="text-[10px] text-green-500">System Ready</div>
        </div>
        
        <div class="p-3 bg-slate-800/50 shadow-inner overflow-x-auto">
            <div class="flex gap-2 min-w-[800px]">
                <input type="text" id="in_plate" placeholder="è»Šç‰Œ" class="w-24 bg-slate-700 border border-slate-500 rounded px-2 py-1 text-white uppercase text-center font-bold">
                <input type="text" id="in_route" placeholder="è·¯ç·š" class="w-16 bg-slate-700 border border-slate-500 rounded px-2 py-1 text-white uppercase text-center">
                <input type="text" id="in_duty" placeholder="å­—è»Œ" class="w-16 bg-slate-700 border border-slate-500 rounded px-2 py-1 text-white uppercase text-center">
                <input type="text" id="in_run_route" placeholder="è¡Œèµ°(é¸å¡«)" class="w-24 bg-slate-700 border border-slate-500 rounded px-2 py-1 text-white uppercase text-center">
                <input type="text" id="in_driver" placeholder="è»Šé•·ç·¨è™Ÿ" class="w-24 bg-slate-700 border border-slate-500 rounded px-2 py-1 text-white text-center">
                <input type="time" id="in_etd" class="bg-slate-700 border border-slate-500 rounded px-2 py-1 text-white">
                <button onclick="submitBusForm()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-1 rounded font-bold shadow transition text-sm">åŠ å…¥</button>
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-hidden grid grid-cols-12">
        <div id="layout-container" class="col-span-9 p-4 overflow-y-auto space-y-6 pb-20"></div>
        <div class="col-span-3 bg-slate-800 border-l border-slate-700 p-4 overflow-y-auto">
            <h2 class="text-lg font-bold mb-4 flex items-center text-orange-400 border-b border-slate-700 pb-2 sticky top-0 bg-slate-800 z-10">
                ğŸ•’ ç‹€æ…‹ç›£æ§
            </h2>
            <div id="monitor_list" class="space-y-3 text-sm">
                <p id="empty_msg" class="text-slate-500 italic text-center py-10">æš«ç„¡è¨ˆæ™‚è»Šè¼›</p>
            </div>
        </div>
    </main>

    <script>
        // ================= é…ç½®è¨­å®š =================
        // è«‹ç¢ºä¿æ­¤è™•ç‚ºå·²æ›´æ–°é doGet å‡½æ•¸çš„ Apps Script URL
        const API_URL = "https://script.google.com/macros/s/AKfycbzRo6udEvwQEDun8MuCnwE4x6neIss47qMajyJu0FpJItW6EG_72ExxQvuzC8QN8VGF/exec";
        
        let SERVER_DB = {}; 

        // ================= å…¨åŸŸè®Šæ•¸ =================
        let currentTerminalId = null;
        let currentTerminalData = null;
        let activeTimers = {};
        let busCount = 0;
        let capacities = {};

        // ================= åˆå§‹åŒ– =================
        window.onload = async () => {
            await fetchTerminalConfig();
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
            startClock();
        };

        // ================= è³‡æ–™è¼‰å…¥é‚è¼¯ =================
        async function fetchTerminalConfig() {
            const listDiv = document.getElementById('terminal-list');
            listDiv.innerHTML = '<p class="text-yellow-400 animate-pulse">æ­£åœ¨ä¸‹è¼‰ç¸½ç«™è³‡æ–™åº«...</p>';
            
            try {
                const config = await callApi('GET', { op: 'get_config' });
                SERVER_DB = config; 
                renderTerminalList();
            } catch (e) {
                listDiv.innerHTML = '<p class="text-red-500 font-bold">ç„¡æ³•é€£æ¥è³‡æ–™åº«</p>';
                console.error(e);
            }
        }

        async function loadTerminal(id) {
            if(Object.keys(activeTimers).length > 0 && !confirm("åˆ‡æ›ç¸½ç«™å°‡æ¸…é™¤ç•¶å‰æ“ä½œï¼Œç¢ºå®šå—ï¼Ÿ")) return;
            
            activeTimers = {};
            document.getElementById('monitor_list').innerHTML = `<p class="text-center text-yellow-400 py-10 animate-pulse">æ­£åœ¨å¾ Google Sheet è¼‰å…¥...</p>`;
            currentTerminalId = id;
            currentTerminalData = SERVER_DB[id];
            capacities = {};
            busCount = 0;

            document.getElementById('current-terminal-name').innerText = currentTerminalData.name;
            document.getElementById('terminal-modal').style.display = 'none';

            // â˜… åœ°åœ–æŒ‰éˆ•æ§åˆ¶ï¼šå¦‚æœè©²ç¸½ç«™æœ‰è¨­å®š layout_imgï¼Œå‰‡é¡¯ç¤ºæŒ‰éˆ•
            const mapBtn = document.getElementById('btn-show-map');
            if (currentTerminalData.layout_img) {
                mapBtn.classList.remove('hidden');
                mapBtn.classList.add('flex');
                document.getElementById('terminal-map-img').src = currentTerminalData.layout_img;
            } else {
                mapBtn.classList.add('hidden');
                mapBtn.classList.remove('flex');
            }

            // æ¸²æŸ“ä½ˆå±€
            const container = document.getElementById('layout-container');
            container.innerHTML = '';
            currentTerminalData.layout.forEach(section => {
                const secHtml = document.createElement('section');
                secHtml.innerHTML = `<h2 class="text-lg font-bold mb-3 text-blue-400 font-mono border-l-4 border-blue-500 pl-2">${section.title}</h2>`;
                const grid = document.createElement('div');
                grid.className = "bay-grid";
                section.bays.forEach(bay => {
                    capacities[bay.id] = bay.cap;
                    const bayDiv = document.createElement('div');
                    bayDiv.id = bay.id;
                    bayDiv.className = "bg-slate-800 p-4 rounded-xl border-2 border-slate-700 transition-colors";
                    if (bay.type === 'no_parking') {
                        bayDiv.innerHTML = `<div class="flex items-center justify-between text-red-400 font-bold"><span>${bay.name}</span><span class="text-[10px] border border-red-500 px-1 rounded animate-pulse">NO PARKING</span></div>`;
                    } else {
                        bayDiv.setAttribute('ondrop', 'drop(event)');
                        bayDiv.setAttribute('ondragover', 'allowDrop(event)');
                        bayDiv.innerHTML = `<h3 class="font-bold mb-3 text-slate-300 text-sm border-b border-slate-700 pb-1 flex justify-between"><span>${bay.name}</span><span class="text-xs text-slate-500">(0/${bay.cap})</span></h3><div class="space-y-3 min-h-[100px]"></div>`;
                    }
                    grid.appendChild(bayDiv);
                });
                secHtml.appendChild(grid);
                container.appendChild(secHtml);
            });

            // è¼‰å…¥è»Šè¼›
            try {
                const buses = await callApi('GET', { op: 'get_buses', terminal_id: id });
                document.getElementById('monitor_list').innerHTML = '';
                buses.forEach(b => {
                    const numId = parseInt(b.id.replace('bus_', ''));
                    if (numId > busCount) busCount = numId;
                    createBusCard(b.id, b.plate, b.route, b.run_route, b.duty, b.driver, b.etd, b.bay_id, true);
                    if (b.status !== 'normal' && b.timer_end) {
                        const endTime = new Date(b.timer_end);
                        const now = new Date();
                        const diffMins = Math.ceil((endTime - now) / 60000);
                        if (diffMins > 0) startTimer(b.id, diffMins, b.status === 'meal' ? 'meal' : 'break', false);
                    }
                });
                if (buses.length === 0) document.getElementById('monitor_list').innerHTML = `<p id="empty_msg" class="text-slate-500 italic text-center py-10">æš«ç„¡è¨ˆæ™‚è»Šè¼›</p>`;
            } catch (e) { alert("ç„¡æ³•é€£æ¥è³‡æ–™åº«"); }
        }

        // ================= åœ°åœ–åŠŸèƒ½ =================
        function showMap() { document.getElementById('map-modal').classList.remove('hidden'); document.getElementById('map-modal').classList.add('flex'); }
        function closeMap() { document.getElementById('map-modal').classList.add('hidden'); document.getElementById('map-modal').classList.remove('flex'); }

        // ================= API æ ¸å¿ƒå‡½æ•¸ =================
        async function callApi(method, payload) {
            const statusEl = document.getElementById('api-status');
            statusEl.innerText = "Syncing...";
            statusEl.className = "text-[10px] text-yellow-400 animate-pulse";
            try {
                if (method === 'GET') {
                    let url = `${API_URL}?op=${payload.op}`;
                    if (payload.terminal_id) url += `&terminal_id=${payload.terminal_id}`;
                    const res = await fetch(url);
                    statusEl.innerText = "Data Loaded";
                    statusEl.className = "text-[10px] text-green-500";
                    return await res.json();
                } else {
                    await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) });
                    statusEl.innerText = "Saved";
                    statusEl.className = "text-[10px] text-green-500";
                    return { status: 'success' };
                }
            } catch (e) {
                console.error("API Error:", e);
                statusEl.innerText = "Sync Error";
                statusEl.className = "text-[10px] text-red-500 font-bold";
                throw e;
            }
        }

        // ================= è¼”åŠ©åŠŸèƒ½èˆ‡é‚è¼¯ (ä¿ç•™ä¸è®Š) =================
        function renderTerminalList() {
            const list = document.getElementById('terminal-list');
            list.innerHTML = '';
            if (Object.keys(SERVER_DB).length === 0) { list.innerHTML = '<p class="text-slate-400">è³‡æ–™åº«ä¸­æ²’æœ‰ç¸½ç«™è³‡æ–™</p>'; return; }
            for (let [key, data] of Object.entries(SERVER_DB)) {
                const btn = document.createElement('button');
                btn.className = "w-full bg-slate-700 hover:bg-slate-600 border border-slate-500 p-4 rounded-xl text-left flex justify-between items-center transition group";
                btn.innerHTML = `<span class="font-bold text-lg group-hover:text-white">${data.name}</span><span class="bg-red-600 text-xs px-2 py-1 rounded text-white">é€²å…¥ &rarr;</span>`;
                btn.onclick = () => loadTerminal(key);
                list.appendChild(btn);
            }
        }
        function showTerminalModal() { document.getElementById('terminal-modal').style.display = 'flex'; }
        
        function checkPlateExists(plate, excludeId = null) {
            const allBuses = document.querySelectorAll('.bus-card');
            for (let bus of allBuses) if (bus.id !== excludeId && bus.dataset.plate === plate.toUpperCase()) return true;
            return false;
        }

        function submitBusForm() {
            if (!currentTerminalId) return alert("è«‹å…ˆé¸æ“‡ç¸½ç«™");
            const plate = document.getElementById('in_plate').value.toUpperCase().trim();
            const route = document.getElementById('in_route').value.toUpperCase().trim();
            const duty = document.getElementById('in_duty').value.toUpperCase().trim();
            const run_route = document.getElementById('in_run_route').value.toUpperCase().trim() || route;
            const driver = document.getElementById('in_driver').value.trim();
            const etd = document.getElementById('in_etd').value || "--:--";

            if (!plate) return alert("è«‹è¼¸å…¥è»Šç‰Œ");
            if (checkPlateExists(plate)) return alert(`âš ï¸ è­¦å‘Šï¼šè»Šç‰Œ ${plate} ç›®å‰å·²åœ¨ç«™å…§ï¼`);

            busCount++;
            const id = `bus_${busCount}`;
            let targetId = currentTerminalData.default_parking;
            outerLoop: for (const section of currentTerminalData.layout) {
                for (const bay of section.bays) {
                    if (bay.routes && bay.routes.includes(run_route)) { targetId = bay.id; break outerLoop; }
                }
            }

            createBusCard(id, plate, route, run_route, duty, driver, etd, targetId, false);
            callApi('POST', { action: 'add', id: id, terminal_id: currentTerminalId, bay_id: targetId, plate: plate, route: route, run_route: run_route, duty: duty, driver: driver, etd: etd });
            ['in_plate','in_duty','in_etd','in_run_route','in_driver'].forEach(i => document.getElementById(i).value = "");
        }

        function createBusCard(id, plate, route, run_route, duty, driver, etd, targetId, isLoadMode) {
            const html = `
                <div id="${id}" draggable="true" ondragstart="drag(event)" class="bus-card status-normal p-3 rounded shadow-lg" 
                     data-plate="${plate}" data-route="${route}" data-run="${run_route}" data-duty="${duty}" data-driver="${driver}" data-etd="${etd}">
                    <div class="flex justify-between items-start mb-1">
                        <div class="font-black text-xl tracking-tight editable" onclick="editField('${id}', 'plate')"><span id="${id}_plate_val">${plate}</span></div>
                        <div class="text-right">
                            <div class="bg-red-600 text-white px-2 py-0.5 rounded text-[11px] font-black italic">è¡Œ:${run_route}</div>
                            <div class="text-[9px] font-bold text-slate-500 mt-0.5">ç·š:${route}</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-1 text-[10px] font-bold mb-2 text-slate-700 border-b border-slate-100 pb-1">
                        <span>å­—è»Œ: ${duty}</span> 
                        <span class="editable" onclick="editField('${id}', 'driver')">è»Šé•·: <span id="${id}_driver_val">${driver}</span></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-bold text-slate-500 editable" onclick="editField('${id}', 'etd')">é–‹è»Š: <span id="${id}_etd_val" class="text-blue-700">${etd}</span></span>
                        <div id="${id}_finish_time" class="text-[10px] font-black text-red-600"></div>
                    </div>
                    <div id="${id}_timer_box" class="hidden mt-2 text-center text-[11px] font-black py-1 rounded bg-black/5"></div>
                    <div class="mt-2 flex gap-1">
                        <button onclick="startTimer('${id}', 60, 'meal')" class="flex-1 text-[9px] bg-orange-500 text-white py-1 rounded font-bold">ç”¨è†³</button>
                        <button onclick="startTimer('${id}', 40, 'break')" class="flex-1 text-[9px] bg-purple-500 text-white py-1 rounded font-bold">å°ä¼‘</button>
                        <button onclick="removeBus('${id}')" class="px-2 text-[9px] bg-slate-200 text-slate-600 py-1 rounded font-bold">å‡ºç«™</button>
                    </div>
                </div>`;
            const targetBay = document.getElementById(targetId);
            if(targetBay) { targetBay.querySelector('div').insertAdjacentHTML('beforeend', html); updateCounts(); }
        }

        function allowDrop(e) { e.preventDefault(); }
        function drag(e) { e.dataTransfer.setData("text", e.target.id); }
        function drop(e) {
            e.preventDefault();
            const busId = e.dataTransfer.getData("text");
            let t = e.target;
            while (t && !capacities.hasOwnProperty(t.id)) t = t.parentElement;
            if (t && capacities.hasOwnProperty(t.id)) { 
                t.querySelector('div').appendChild(document.getElementById(busId)); 
                updateCounts(); 
                callApi('POST', { action: 'update', id: busId, bay_id: t.id });
            }
        }

        function startTimer(id, mins, type, syncToDb = true) {
            const bus = document.getElementById(id);
            const typeText = type === 'meal' ? 'ç”¨è†³' : 'å°ä¼‘';
            const now = new Date();
            const finishDate = new Date(now.getTime() + mins * 60000);
            const finishStr = `${finishDate.getHours().toString().padStart(2,'0')}:${finishDate.getMinutes().toString().padStart(2,'0')}`;
            if (activeTimers[id]) clearInterval(activeTimers[id].interval);
            bus.className = `bus-card p-3 rounded shadow-lg ${type === 'meal' ? 'status-meal' : 'status-break'}`;
            document.getElementById(`${id}_finish_time`).innerText = `ğŸ”š ${finishStr}`;
            let seconds = mins * 60;
            const updateUI = () => {
                const m = Math.floor(seconds / 60), s = seconds % 60;
                const timeStr = `${m}:${s < 10 ? '0' : ''}${s}`;
                const timerBox = document.getElementById(id + '_timer_box');
                timerBox.classList.remove('hidden');
                timerBox.innerText = `${typeText}: ${timeStr}`;
                updateMonitor(id, typeText, timeStr, finishStr, seconds <= 0);
                if (seconds <= 0) { clearInterval(activeTimers[id].interval); timerBox.innerText = "æ™‚é–“å®Œæˆ"; }
                seconds--;
            };
            activeTimers[id] = { interval: setInterval(updateUI, 1000), plate: bus.dataset.plate, run: bus.dataset.run };
            updateUI();
            if (syncToDb) callApi('POST', { action: 'update', id: id, status: type, timer_end: finishDate.toISOString() });
        }

        function updateMonitor(id, type, timeStr, finishStr, isDone) {
            document.getElementById('empty_msg').classList.add('hidden');
            let item = document.getElementById(`mon_${id}`);
            if (!item) {
                item = document.createElement('div');
                item.id = `mon_${id}`;
                item.className = "bg-slate-700 p-3 rounded border-l-4 mb-2 shadow transition-all";
                document.getElementById('monitor_list').appendChild(item);
            }
            item.style.borderColor = type === 'ç”¨è†³' ? '#f97316' : '#a855f7';
            item.innerHTML = `<div class="flex justify-between font-black text-white"><span>${activeTimers[id].plate} (${activeTimers[id].run})</span><span class="${isDone ? 'text-red-500 animate-pulse' : 'text-orange-400'} font-mono">${timeStr}</span></div><div class="flex justify-between items-center mt-1"><span class="text-[10px] text-slate-400 font-bold">${type}</span><span class="text-[11px] bg-slate-800 px-2 py-0.5 rounded text-white border border-slate-600 font-mono">${finishStr}</span></div>`;
        }

        function removeBus(id, isAuto = false) {
            const bus = document.getElementById(id);
            if (!bus) return;
            if (!isAuto && !confirm(`ç¢ºèªè»Šç‰Œ ${bus.dataset.plate} å‡ºç«™ï¼Ÿ`)) return;
            if (activeTimers[id]) { clearInterval(activeTimers[id].interval); const mon = document.getElementById(`mon_${id}`); if (mon) mon.remove(); delete activeTimers[id]; }
            bus.remove();
            if (Object.keys(activeTimers).length === 0) document.getElementById('empty_msg').classList.remove('hidden');
            updateCounts();
            callApi('POST', { action: 'delete', id: id });
        }

        function editField(id, field) {
            const bus = document.getElementById(id);
            let newVal;
            let updatePayload = { action: 'update', id: id };
            if (field === 'plate') {
                newVal = prompt("ä¿®æ”¹è»Šç‰Œè™Ÿç¢¼:", bus.dataset.plate).toUpperCase().trim();
                if (newVal && newVal !== bus.dataset.plate) {
                    if (checkPlateExists(newVal, id)) return alert("è»Šç‰Œé‡è¤‡ï¼");
                    bus.dataset.plate = newVal; document.getElementById(`${id}_plate_val`).innerText = newVal; if(activeTimers[id]) activeTimers[id].plate = newVal; updatePayload.plate = newVal;
                } else return;
            } else if (field === 'driver') {
                newVal = prompt("ä¿®æ”¹è»Šé•·ç·¨è™Ÿ:", bus.dataset.driver).trim();
                if (newVal) { bus.dataset.driver = newVal; document.getElementById(`${id}_driver_val`).innerText = newVal; updatePayload.driver = newVal; } else return;
            } else if (field === 'etd') {
                newVal = prompt("ä¿®æ”¹é è¨ˆé–‹è»Šæ™‚é–“ (HH:mm):", bus.dataset.etd).trim();
                if (newVal && /^([01]\d|2[0-3]):?([0-5]\d)$/.test(newVal)) { bus.dataset.etd = newVal; document.getElementById(`${id}_etd_val`).innerText = newVal; updatePayload.etd = newVal; } else return;
            }
            callApi('POST', updatePayload);
        }

        function updateCounts() {
            for (let id in capacities) {
                const el = document.getElementById(id);
                if (!el) continue;
                const count = el.querySelector('div').children.length;
                const h3Span = el.querySelector('h3 span:last-child');
                if(h3Span) h3Span.innerText = `(${count}/${capacities[id]})`;
                el.classList.toggle('bg-red-900/20', count > capacities[id] && capacities[id] > 0);
                el.classList.toggle('border-red-500', count > capacities[id] && capacities[id] > 0);
            }
        }

        function startClock() {
            setInterval(() => {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-HK', { hour12: false });
                document.getElementById('clock').innerText = timeStr;
                const shortTime = timeStr.substring(0, 5);
                document.querySelectorAll('.bus-card').forEach(bus => {
                    const etd = bus.dataset.etd;
                    if (etd !== "--:--" && etd === shortTime) removeBus(bus.id, true);
                    const [h, m] = etd.split(':').map(Number);
                    const etdDate = new Date(); etdDate.setHours(h, m, 0);
                    const diff = (etdDate - now) / 60000;
                    const etdDisplay = document.getElementById(`${bus.id}_etd_val`);
                    if (etdDisplay) { if (diff > 0 && diff <= 5) etdDisplay.classList.add('etd-danger'); else etdDisplay.classList.remove('etd-danger'); }
                });
            }, 1000);
        }
    </script>
</body>
</html>
